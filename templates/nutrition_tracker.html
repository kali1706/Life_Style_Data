{% extends "base.html" %}

{% block title %}Nutrition Tracker - Lifestyle Analytics Platform{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-primary mb-1">
                        <i class="fas fa-apple-alt me-2"></i>Nutrition Tracker
                    </h2>
                    <p class="text-muted mb-0">Track your meals and monitor your nutritional intake</p>
                </div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNutritionModal">
                    <i class="fas fa-plus me-2"></i>Log New Meal
                </button>
            </div>
        </div>
    </div>

    <!-- Daily Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-utensils fa-2x mb-2"></i>
                    <h4>{{ nutrition_logs|length if nutrition_logs else 0 }}</h4>
                    <p class="mb-0">Meals Logged</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-danger text-white">
                <div class="card-body text-center">
                    <i class="fas fa-fire fa-2x mb-2"></i>
                    <h4>{{ "{:,}".format(nutrition_logs|sum(attribute='calories') if nutrition_logs else 0) }}</h4>
                    <p class="mb-0">Total Calories</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-tint fa-2x mb-2"></i>
                    <h4>{{ "%.1f"|format(nutrition_logs|sum(attribute='water_intake') if nutrition_logs else 0) }}</h4>
                    <p class="mb-0">Water (Liters)</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-leaf fa-2x mb-2"></i>
                    <h4>{{ "%.0f"|format((nutrition_logs|selectattr('is_healthy')|list|length / nutrition_logs|length * 100) if nutrition_logs else 0) }}%</h4>
                    <p class="mb-0">Healthy Meals</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Macro Overview -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2 text-primary"></i>Today's Macro Breakdown
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="macroChart" height="200"></canvas>
                        </div>
                        <div class="col-md-6">
                            <div class="macro-details">
                                {% set total_carbs = nutrition_logs|sum(attribute='carbs') if nutrition_logs else 0 %}
                                {% set total_proteins = nutrition_logs|sum(attribute='proteins') if nutrition_logs else 0 %}
                                {% set total_fats = nutrition_logs|sum(attribute='fats') if nutrition_logs else 0 %}
                                {% set total_macro_calories = (total_carbs * 4) + (total_proteins * 4) + (total_fats * 9) %}
                                
                                <div class="macro-item mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="macro-label">
                                            <i class="fas fa-circle text-warning me-2"></i>Carbohydrates
                                        </span>
                                        <span class="macro-value">{{ total_carbs }}g</span>
                                    </div>
                                    <div class="progress mb-1" style="height: 8px;">
                                        <div class="progress-bar bg-warning" style="width: {{ (total_carbs * 4 / total_macro_calories * 100) if total_macro_calories else 0 }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ "%.1f"|format((total_carbs * 4 / total_macro_calories * 100) if total_macro_calories else 0) }}% (Target: 45-65%)</small>
                                </div>

                                <div class="macro-item mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="macro-label">
                                            <i class="fas fa-circle text-success me-2"></i>Proteins
                                        </span>
                                        <span class="macro-value">{{ total_proteins }}g</span>
                                    </div>
                                    <div class="progress mb-1" style="height: 8px;">
                                        <div class="progress-bar bg-success" style="width: {{ (total_proteins * 4 / total_macro_calories * 100) if total_macro_calories else 0 }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ "%.1f"|format((total_proteins * 4 / total_macro_calories * 100) if total_macro_calories else 0) }}% (Target: 15-25%)</small>
                                </div>

                                <div class="macro-item mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="macro-label">
                                            <i class="fas fa-circle text-info me-2"></i>Fats
                                        </span>
                                        <span class="macro-value">{{ total_fats }}g</span>
                                    </div>
                                    <div class="progress mb-1" style="height: 8px;">
                                        <div class="progress-bar bg-info" style="width: {{ (total_fats * 9 / total_macro_calories * 100) if total_macro_calories else 0 }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ "%.1f"|format((total_fats * 9 / total_macro_calories * 100) if total_macro_calories else 0) }}% (Target: 20-35%)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-bullseye me-2 text-primary"></i>Daily Goals
                    </h5>
                </div>
                <div class="card-body">
                    <div class="goal-item mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="goal-label">Calories</span>
                            <span class="goal-value">{{ nutrition_logs|sum(attribute='calories') if nutrition_logs else 0 }} / 2000</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-danger" style="width: {{ (nutrition_logs|sum(attribute='calories') / 2000 * 100) if nutrition_logs else 0 }}%"></div>
                        </div>
                    </div>

                    <div class="goal-item mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="goal-label">Water</span>
                            <span class="goal-value">{{ "%.1f"|format(nutrition_logs|sum(attribute='water_intake') if nutrition_logs else 0) }} / 2.5L</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-info" style="width: {{ (nutrition_logs|sum(attribute='water_intake') / 2.5 * 100) if nutrition_logs else 0 }}%"></div>
                        </div>
                    </div>

                    <div class="goal-item mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="goal-label">Protein</span>
                            <span class="goal-value">{{ nutrition_logs|sum(attribute='proteins') if nutrition_logs else 0 }}g / 150g</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-success" style="width: {{ (nutrition_logs|sum(attribute='proteins') / 150 * 100) if nutrition_logs else 0 }}%"></div>
                        </div>
                    </div>

                    <div class="text-center mt-3">
                        <button class="btn btn-outline-primary btn-sm" onclick="updateGoals()">
                            <i class="fas fa-edit me-1"></i>Update Goals
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Nutrition History -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2 text-primary"></i>Nutrition History
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterMeals('all')">All</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterMeals('Breakfast')">Breakfast</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterMeals('Lunch')">Lunch</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterMeals('Dinner')">Dinner</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterMeals('Snack')">Snacks</button>
                    </div>
                </div>
                <div class="card-body">
                    {% if nutrition_logs %}
                        <div class="table-responsive">
                            <table class="table table-hover" id="nutritionTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Meal</th>
                                        <th>Calories</th>
                                        <th>Macros (C/P/F)</th>
                                        <th>Water</th>
                                        <th>Healthy</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for nutrition in nutrition_logs %}
                                    <tr data-meal-type="{{ nutrition.meal_name }}">
                                        <td>
                                            <strong>{{ nutrition.date.strftime('%m/%d/%Y') }}</strong>
                                            <br><small class="text-muted">{{ nutrition.date.strftime('%A') }}</small>
                                        </td>
                                        <td>
                                            <span class="badge 
                                                {% if nutrition.meal_name == 'Breakfast' %}bg-warning
                                                {% elif nutrition.meal_name == 'Lunch' %}bg-success
                                                {% elif nutrition.meal_name == 'Dinner' %}bg-primary
                                                {% else %}bg-info{% endif %}">
                                                {{ nutrition.meal_name }}
                                            </span>
                                            {% if nutrition.diet_type %}
                                                <br><small class="text-muted">{{ nutrition.diet_type }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <i class="fas fa-fire text-danger me-1"></i>
                                            <strong>{{ nutrition.calories }}</strong> kcal
                                        </td>
                                        <td>
                                            <div class="macro-mini">
                                                <span class="badge bg-warning">C: {{ nutrition.carbs }}g</span>
                                                <span class="badge bg-success">P: {{ nutrition.proteins }}g</span>
                                                <span class="badge bg-info">F: {{ nutrition.fats }}g</span>
                                            </div>
                                        </td>
                                        <td>
                                            {% if nutrition.water_intake > 0 %}
                                                <i class="fas fa-tint text-info me-1"></i>
                                                {{ "%.1f"|format(nutrition.water_intake) }}L
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if nutrition.is_healthy %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check me-1"></i>Healthy
                                                </span>
                                            {% else %}
                                                <span class="badge bg-warning">
                                                    <i class="fas fa-exclamation me-1"></i>Treat
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" onclick="editNutrition({{ nutrition.id }})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="deleteNutrition({{ nutrition.id }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-apple-alt fa-4x text-muted mb-3"></i>
                            <h4 class="text-muted">No meals logged yet</h4>
                            <p class="text-muted mb-4">Start tracking your nutrition by logging your first meal!</p>
                            <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addNutritionModal">
                                <i class="fas fa-plus me-2"></i>Log Your First Meal
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Nutrition Modal -->
<div class="modal fade" id="addNutritionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Log New Meal
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="nutritionForm">
                    <div class="row">
                        <!-- Basic Information -->
                        <div class="col-md-6 mb-3">
                            <label for="meal_name" class="form-label">Meal Type</label>
                            <select class="form-select" id="meal_name" name="meal_name" required>
                                <option value="">Select Meal</option>
                                <option value="Breakfast">Breakfast</option>
                                <option value="Lunch">Lunch</option>
                                <option value="Dinner">Dinner</option>
                                <option value="Snack">Snack</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="date" name="date" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="diet_type" class="form-label">Diet Type</label>
                            <select class="form-select" id="diet_type" name="diet_type">
                                <option value="">Select Diet Type</option>
                                <option value="Balanced">Balanced</option>
                                <option value="Keto">Keto</option>
                                <option value="Vegan">Vegan</option>
                                <option value="Vegetarian">Vegetarian</option>
                                <option value="Paleo">Paleo</option>
                                <option value="Mediterranean">Mediterranean</option>
                                <option value="Low Carb">Low Carb</option>
                                <option value="High Protein">High Protein</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="calories" class="form-label">Calories</label>
                            <input type="number" class="form-control" id="calories" name="calories" min="1" max="2000" required>
                        </div>
                    </div>

                    <!-- Macronutrients -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="carbs" class="form-label">Carbohydrates (g)</label>
                            <input type="number" class="form-control" id="carbs" name="carbs" min="0" max="500" required>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="proteins" class="form-label">Proteins (g)</label>
                            <input type="number" class="form-control" id="proteins" name="proteins" min="0" max="200" required>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="fats" class="form-label">Fats (g)</label>
                            <input type="number" class="form-control" id="fats" name="fats" min="0" max="200" required>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="water_intake" class="form-label">Water Intake (L)</label>
                            <input type="number" class="form-control" id="water_intake" name="water_intake" step="0.1" min="0" max="5">
                            <div class="form-text">Optional - water consumed with this meal</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="serving_size" class="form-label">Serving Size (g)</label>
                            <input type="number" class="form-control" id="serving_size" name="serving_size" min="1" max="1000">
                            <div class="form-text">Optional</div>
                        </div>
                    </div>

                    <!-- Health Status -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_healthy" name="is_healthy" checked>
                                <label class="form-check-label" for="is_healthy">
                                    This is a healthy meal
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Macro Calculator -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <i class="fas fa-calculator me-2"></i>Quick Macro Calculator
                        </h6>
                        <p class="mb-2">Calculate macros from calories:</p>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-warning btn-sm w-100" onclick="calculateMacros('balanced')">
                                    Balanced<br><small>40C/30P/30F</small>
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-success btn-sm w-100" onclick="calculateMacros('highprotein')">
                                    High Protein<br><small>30C/40P/30F</small>
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-info btn-sm w-100" onclick="calculateMacros('lowcarb')">
                                    Low Carb<br><small>20C/35P/45F</small>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitNutrition()">
                    <i class="fas fa-save me-2"></i>Log Meal
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default
    document.getElementById('date').valueAsDate = new Date();
    
    // Initialize macro chart
    initializeMacroChart();
});

function initializeMacroChart() {
    const ctx = document.getElementById('macroChart');
    if (!ctx) return;

    const totalCarbs = {{ nutrition_logs|sum(attribute='carbs') if nutrition_logs else 0 }};
    const totalProteins = {{ nutrition_logs|sum(attribute='proteins') if nutrition_logs else 0 }};
    const totalFats = {{ nutrition_logs|sum(attribute='fats') if nutrition_logs else 0 }};

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Carbohydrates', 'Proteins', 'Fats'],
            datasets: [{
                data: [totalCarbs * 4, totalProteins * 4, totalFats * 9],
                backgroundColor: ['#ffc107', '#28a745', '#17a2b8'],
                borderColor: ['#e0a800', '#1e7e34', '#117a8b'],
                borderWidth: 2,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label;
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return label + ': ' + percentage + '%';
                        }
                    }
                }
            },
            cutout: '60%'
        }
    });
}

function filterMeals(type) {
    const rows = document.querySelectorAll('#nutritionTable tbody tr');
    const buttons = document.querySelectorAll('.btn-group button');
    
    // Update active button
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    rows.forEach(row => {
        if (type === 'all' || row.dataset.mealType === type) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function calculateMacros(type) {
    const caloriesInput = document.getElementById('calories');
    const carbsInput = document.getElementById('carbs');
    const proteinsInput = document.getElementById('proteins');
    const fatsInput = document.getElementById('fats');
    
    const calories = parseFloat(caloriesInput.value) || 0;
    if (calories === 0) {
        alert('Please enter calories first');
        return;
    }
    
    let carbPercent, proteinPercent, fatPercent;
    
    switch(type) {
        case 'balanced':
            carbPercent = 40; proteinPercent = 30; fatPercent = 30;
            break;
        case 'highprotein':
            carbPercent = 30; proteinPercent = 40; fatPercent = 30;
            break;
        case 'lowcarb':
            carbPercent = 20; proteinPercent = 35; fatPercent = 45;
            break;
        default:
            carbPercent = 40; proteinPercent = 30; fatPercent = 30;
    }
    
    const carbCalories = calories * (carbPercent / 100);
    const proteinCalories = calories * (proteinPercent / 100);
    const fatCalories = calories * (fatPercent / 100);
    
    carbsInput.value = Math.round(carbCalories / 4);
    proteinsInput.value = Math.round(proteinCalories / 4);
    fatsInput.value = Math.round(fatCalories / 9);
}

function submitNutrition() {
    const form = document.getElementById('nutritionForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Convert checkbox to boolean
    data.is_healthy = document.getElementById('is_healthy').checked;
    
    // Validation
    if (!data.meal_name || !data.calories || !data.carbs || !data.proteins || !data.fats || !data.date) {
        alert('Please fill in all required fields');
        return;
    }
    
    fetch('/nutrition_tracker', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Meal logged successfully!');
            location.reload();
        } else {
            alert(data.message || 'Failed to log meal');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while logging the meal');
    });
}

function editNutrition(nutritionId) {
    // Implementation for editing nutrition
    alert('Edit functionality coming soon!');
}

function deleteNutrition(nutritionId) {
    if (confirm('Are you sure you want to delete this meal?')) {
        // Implementation for deleting nutrition
        alert('Delete functionality coming soon!');
    }
}

function updateGoals() {
    alert('Goal setting functionality coming soon!');
}
</script>

<style>
.macro-item {
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 10px;
    border-left: 4px solid #007bff;
}

.macro-label {
    font-weight: 600;
    color: #495057;
}

.macro-value {
    font-weight: 700;
    color: #007bff;
}

.goal-item {
    padding: 10px 0;
    border-bottom: 1px solid #f0f0f0;
}

.goal-item:last-child {
    border-bottom: none;
}

.goal-label {
    font-weight: 600;
    color: #6c757d;
}

.goal-value {
    font-weight: 700;
    color: #007bff;
}

.macro-mini .badge {
    font-size: 0.7rem;
    margin-right: 2px;
}

.stat-card {
    border: none;
    border-radius: 15px;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.btn-group .btn.active {
    background-color: #007bff;
    color: white;
}

.modal-content {
    border: none;
    border-radius: 15px;
}

.form-control:focus, .form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.alert-info {
    border-radius: 10px;
    border-left: 4px solid #17a2b8;
}

.card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
</style>
{% endblock %}