{% extends "base.html" %}

{% block title %}Workout Tracker - Lifestyle Analytics Platform{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-primary mb-1">
                        <i class="fas fa-dumbbell me-2"></i>Workout Tracker
                    </h2>
                    <p class="text-muted mb-0">Log your workouts and track your fitness progress</p>
                </div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWorkoutModal">
                    <i class="fas fa-plus me-2"></i>Log New Workout
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-calendar-week fa-2x mb-2"></i>
                    <h4>{{ workouts|length if workouts else 0 }}</h4>
                    <p class="mb-0">Total Workouts</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-fire fa-2x mb-2"></i>
                    <h4>{{ "{:,}".format(workouts|sum(attribute='calories_burned') if workouts else 0) }}</h4>
                    <p class="mb-0">Calories Burned</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h4>{{ "%.1f"|format(workouts|sum(attribute='session_duration') if workouts else 0) }}</h4>
                    <p class="mb-0">Total Hours</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-heartbeat fa-2x mb-2"></i>
                    <h4>{{ "%.0f"|format((workouts|sum(attribute='avg_bpm')/workouts|length) if workouts and workouts|selectattr('avg_bpm')|list else 0) }}</h4>
                    <p class="mb-0">Avg Heart Rate</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Workout History -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2 text-primary"></i>Workout History
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterWorkouts('all')">All</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterWorkouts('Strength')">Strength</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterWorkouts('Cardio')">Cardio</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterWorkouts('HIIT')">HIIT</button>
                    </div>
                </div>
                <div class="card-body">
                    {% if workouts %}
                        <div class="table-responsive">
                            <table class="table table-hover" id="workoutTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Duration</th>
                                        <th>Calories</th>
                                        <th>Heart Rate</th>
                                        <th>Intensity</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for workout in workouts %}
                                    <tr data-workout-type="{{ workout.workout_type }}">
                                        <td>
                                            <strong>{{ workout.date.strftime('%m/%d/%Y') }}</strong>
                                            <br><small class="text-muted">{{ workout.date.strftime('%A') }}</small>
                                        </td>
                                        <td>
                                            <span class="badge 
                                                {% if workout.workout_type == 'Strength' %}bg-primary
                                                {% elif workout.workout_type == 'Cardio' %}bg-success
                                                {% elif workout.workout_type == 'HIIT' %}bg-danger
                                                {% elif workout.workout_type == 'Yoga' %}bg-info
                                                {% else %}bg-secondary{% endif %}">
                                                {{ workout.workout_type }}
                                            </span>
                                        </td>
                                        <td>
                                            <i class="fas fa-clock text-muted me-1"></i>
                                            {{ "%.1f"|format(workout.session_duration) }}h
                                        </td>
                                        <td>
                                            <i class="fas fa-fire text-danger me-1"></i>
                                            {{ workout.calories_burned }} kcal
                                        </td>
                                        <td>
                                            {% if workout.avg_bpm %}
                                                <i class="fas fa-heartbeat text-danger me-1"></i>
                                                {{ workout.avg_bpm }} bpm
                                                {% if workout.max_bpm %}
                                                    <br><small class="text-muted">Max: {{ workout.max_bpm }}</small>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if workout.intensity_level %}
                                                <span class="badge 
                                                    {% if workout.intensity_level == 'High' %}bg-danger
                                                    {% elif workout.intensity_level == 'Moderate' %}bg-warning
                                                    {% else %}bg-success{% endif %}">
                                                    {{ workout.intensity_level }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" onclick="editWorkout({{ workout.id }})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="deleteWorkout({{ workout.id }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-dumbbell fa-4x text-muted mb-3"></i>
                            <h4 class="text-muted">No workouts logged yet</h4>
                            <p class="text-muted mb-4">Start tracking your fitness journey by logging your first workout!</p>
                            <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addWorkoutModal">
                                <i class="fas fa-plus me-2"></i>Log Your First Workout
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Workout Modal -->
<div class="modal fade" id="addWorkoutModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Log New Workout
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="workoutForm">
                    <div class="row">
                        <!-- Basic Information -->
                        <div class="col-md-6 mb-3">
                            <label for="workout_type" class="form-label">Workout Type</label>
                            <select class="form-select" id="workout_type" name="workout_type" required>
                                <option value="">Select Type</option>
                                <option value="Strength">Strength Training</option>
                                <option value="Cardio">Cardio</option>
                                <option value="HIIT">HIIT</option>
                                <option value="Yoga">Yoga</option>
                                <option value="Pilates">Pilates</option>
                                <option value="Swimming">Swimming</option>
                                <option value="Running">Running</option>
                                <option value="Cycling">Cycling</option>
                                <option value="Sports">Sports</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="date" name="date" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="session_duration" class="form-label">Duration (hours)</label>
                            <input type="number" class="form-control" id="session_duration" name="session_duration" 
                                   step="0.25" min="0.25" max="8" required>
                            <div class="form-text">Example: 1.5 for 1 hour 30 minutes</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="calories_burned" class="form-label">Calories Burned</label>
                            <input type="number" class="form-control" id="calories_burned" name="calories_burned" 
                                   min="50" max="2000" required>
                        </div>
                    </div>

                    <!-- Heart Rate Information -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="avg_bpm" class="form-label">Average Heart Rate (BPM)</label>
                            <input type="number" class="form-control" id="avg_bpm" name="avg_bpm" 
                                   min="60" max="220">
                            <div class="form-text">Optional</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="max_bpm" class="form-label">Maximum Heart Rate (BPM)</label>
                            <input type="number" class="form-control" id="max_bpm" name="max_bpm" 
                                   min="80" max="220">
                            <div class="form-text">Optional</div>
                        </div>
                    </div>

                    <!-- Intensity Level -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="intensity_level" class="form-label">Intensity Level</label>
                            <select class="form-select" id="intensity_level" name="intensity_level">
                                <option value="">Select Intensity</option>
                                <option value="Low">Low</option>
                                <option value="Moderate">Moderate</option>
                                <option value="High">High</option>
                                <option value="Very High">Very High</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="workout_frequency" class="form-label">Weekly Frequency</label>
                            <select class="form-select" id="workout_frequency" name="workout_frequency">
                                <option value="">Select Frequency</option>
                                <option value="1">1 time per week</option>
                                <option value="2">2 times per week</option>
                                <option value="3">3 times per week</option>
                                <option value="4">4 times per week</option>
                                <option value="5">5 times per week</option>
                                <option value="6">6 times per week</option>
                                <option value="7">Daily</option>
                            </select>
                        </div>
                    </div>

                    <!-- Quick Calorie Calculator -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <i class="fas fa-calculator me-2"></i>Quick Calorie Calculator
                        </h6>
                        <p class="mb-2">Estimate calories burned based on activity:</p>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-info btn-sm w-100" onclick="calculateCalories('light')">
                                    Light Activity<br><small>300-400 kcal/hr</small>
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-warning btn-sm w-100" onclick="calculateCalories('moderate')">
                                    Moderate Activity<br><small>400-600 kcal/hr</small>
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="calculateCalories('intense')">
                                    Intense Activity<br><small>600-800 kcal/hr</small>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitWorkout()">
                    <i class="fas fa-save me-2"></i>Log Workout
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Exercise Library Modal -->
<div class="modal fade" id="exerciseLibraryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-book me-2"></i>Exercise Library
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    {% if exercises %}
                        {% for exercise in exercises %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100 exercise-card">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">{{ exercise.name }}</h6>
                                    <div class="mb-2">
                                        <span class="badge bg-primary">{{ exercise.target_muscle_group }}</span>
                                        <span class="badge bg-secondary">{{ exercise.difficulty_level }}</span>
                                    </div>
                                    <p class="card-text small">{{ exercise.benefit[:100] }}...</p>
                                    <div class="exercise-details">
                                        <small class="text-muted">
                                            <i class="fas fa-dumbbell me-1"></i>{{ exercise.equipment_needed }}<br>
                                            <i class="fas fa-fire me-1"></i>{{ exercise.burns_calories_per_30min }} kcal/30min
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="col-12 text-center">
                            <p class="text-muted">No exercises in library yet.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default
    document.getElementById('date').valueAsDate = new Date();
});

function filterWorkouts(type) {
    const rows = document.querySelectorAll('#workoutTable tbody tr');
    const buttons = document.querySelectorAll('.btn-group button');
    
    // Update active button
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    rows.forEach(row => {
        if (type === 'all' || row.dataset.workoutType === type) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function calculateCalories(intensity) {
    const durationInput = document.getElementById('session_duration');
    const caloriesInput = document.getElementById('calories_burned');
    const duration = parseFloat(durationInput.value) || 1;
    
    let caloriesPerHour;
    switch(intensity) {
        case 'light':
            caloriesPerHour = 350;
            break;
        case 'moderate':
            caloriesPerHour = 500;
            break;
        case 'intense':
            caloriesPerHour = 700;
            break;
        default:
            caloriesPerHour = 400;
    }
    
    const estimatedCalories = Math.round(caloriesPerHour * duration);
    caloriesInput.value = estimatedCalories;
}

function submitWorkout() {
    const form = document.getElementById('workoutForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Validation
    if (!data.workout_type || !data.session_duration || !data.calories_burned || !data.date) {
        alert('Please fill in all required fields');
        return;
    }
    
    fetch('/workout_tracker', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Workout logged successfully!');
            location.reload();
        } else {
            alert(data.message || 'Failed to log workout');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while logging the workout');
    });
}

function editWorkout(workoutId) {
    // Implementation for editing workout
    alert('Edit functionality coming soon!');
}

function deleteWorkout(workoutId) {
    if (confirm('Are you sure you want to delete this workout?')) {
        // Implementation for deleting workout
        alert('Delete functionality coming soon!');
    }
}

// Show exercise library
function showExerciseLibrary() {
    const modal = new bootstrap.Modal(document.getElementById('exerciseLibraryModal'));
    modal.show();
}
</script>

<style>
.stat-card {
    border: none;
    border-radius: 15px;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.exercise-card {
    transition: transform 0.2s ease;
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.exercise-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
}

.badge {
    font-size: 0.75rem;
}

.btn-group .btn.active {
    background-color: #007bff;
    color: white;
}

.modal-content {
    border: none;
    border-radius: 15px;
}

.modal-header {
    border-radius: 15px 15px 0 0;
}

.form-control:focus, .form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.alert-info {
    border-radius: 10px;
    border-left: 4px solid #17a2b8;
}

.card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
</style>
{% endblock %}