{% extends "base.html" %}

{% block title %}Profile - Lifestyle Analytics Platform{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Profile Header -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-user-edit me-2"></i>User Profile
                    </h3>
                    <p class="mb-0 mt-2 opacity-75">Manage your personal information and fitness data</p>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3 text-center">
                            <div class="profile-avatar bg-primary text-white rounded-circle mx-auto mb-3">
                                <i class="fas fa-user fa-3x"></i>
                            </div>
                            <h5>{{ user.username }}</h5>
                            <p class="text-muted">{{ user.email }}</p>
                        </div>
                        <div class="col-md-9">
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="profile-stat">
                                        <span class="stat-label">Member Since</span>
                                        <span class="stat-value">{{ user.created_at.strftime('%B %Y') }}</span>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="profile-stat">
                                        <span class="stat-label">Experience Level</span>
                                        <span class="stat-value">{{ user.get_experience_level_text() }}</span>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="profile-stat">
                                        <span class="stat-label">Current BMI</span>
                                        <span class="stat-value">
                                            {{ "%.1f"|format(user.bmi) }} 
                                            <small class="text-muted">({{ user.get_bmi_category() }})</small>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="profile-stat">
                                        <span class="stat-label">Last Updated</span>
                                        <span class="stat-value">{{ user.updated_at.strftime('%m/%d/%Y') }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Profile Form -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-edit me-2 text-primary"></i>Update Profile Information
                    </h5>
                </div>
                <div class="card-body">
                    <form id="profileForm" method="POST">
                        <!-- Basic Information -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-3 border-bottom pb-2">
                                <i class="fas fa-user me-2"></i>Basic Information
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="username" value="{{ user.username }}" readonly>
                                    <div class="form-text">Username cannot be changed</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" value="{{ user.email }}" readonly>
                                    <div class="form-text">Email cannot be changed</div>
                                </div>
                            </div>
                        </div>

                        <!-- Physical Information -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-3 border-bottom pb-2">
                                <i class="fas fa-weight me-2"></i>Physical Information
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="age" class="form-label">Age</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="age" name="age" value="{{ user.age }}" min="13" max="120" required>
                                        <span class="input-group-text">years</span>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="gender" class="form-label">Gender</label>
                                    <select class="form-select" id="gender" name="gender" disabled>
                                        <option value="Male" {{ 'selected' if user.gender == 'Male' }}>Male</option>
                                        <option value="Female" {{ 'selected' if user.gender == 'Female' }}>Female</option>
                                        <option value="Other" {{ 'selected' if user.gender == 'Other' }}>Other</option>
                                    </select>
                                    <div class="form-text">Gender cannot be changed</div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="experience_level" class="form-label">Experience Level</label>
                                    <select class="form-select" id="experience_level" name="experience_level" required>
                                        <option value="1" {{ 'selected' if user.experience_level == 1 }}>Beginner</option>
                                        <option value="2" {{ 'selected' if user.experience_level == 2 }}>Intermediate</option>
                                        <option value="3" {{ 'selected' if user.experience_level == 3 }}>Advanced</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="height" class="form-label">Height</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="height" name="height" value="{{ user.height }}" step="0.01" min="1.0" max="2.5" required>
                                        <span class="input-group-text">meters</span>
                                    </div>
                                    <div class="form-text">Example: 1.75 for 5'9"</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="weight" class="form-label">Weight</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="weight" name="weight" value="{{ user.weight }}" step="0.1" min="30" max="300" required>
                                        <span class="input-group-text">kg</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Metrics -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-3 border-bottom pb-2">
                                <i class="fas fa-heartbeat me-2"></i>Additional Metrics
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="fat_percentage" class="form-label">Body Fat Percentage</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="fat_percentage" name="fat_percentage" 
                                               value="{{ user.fat_percentage or '' }}" step="0.1" min="5" max="50">
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <div class="form-text">Optional - if you have this measurement</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="resting_bpm" class="form-label">Resting Heart Rate</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="resting_bpm" name="resting_bpm" 
                                               value="{{ user.resting_bpm or '' }}" min="40" max="120">
                                        <span class="input-group-text">bpm</span>
                                    </div>
                                    <div class="form-text">Optional - typically 60-100 bpm</div>
                                </div>
                            </div>
                        </div>

                        <!-- BMI Display -->
                        <div class="mb-4">
                            <div class="alert alert-info" id="bmiDisplay">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>Current BMI: </strong>
                                        <span id="bmiValue">{{ "%.1f"|format(user.bmi) }}</span> - 
                                        <span id="bmiCategory">{{ user.get_bmi_category() }}</span>
                                    </div>
                                    <div class="bmi-chart">
                                        <div class="progress" style="width: 200px; height: 20px;">
                                            {% set bmi_percentage = ((user.bmi - 15) / 20 * 100) if user.bmi else 0 %}
                                            <div class="progress-bar 
                                                {% if user.bmi < 18.5 %}bg-warning
                                                {% elif user.bmi <= 24.9 %}bg-success
                                                {% elif user.bmi <= 29.9 %}bg-warning
                                                {% else %}bg-danger{% endif %}" 
                                                style="width: {{ bmi_percentage }}%"></div>
                                        </div>
                                        <small class="text-muted d-block mt-1">15 - 35 BMI Range</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>Update Profile
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Health Insights -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb me-2 text-warning"></i>Health Insights
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="insight-item mb-3">
                                <h6 class="text-primary">BMI Status</h6>
                                {% if user.bmi < 18.5 %}
                                    <p class="text-warning mb-0">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        You're underweight. Consider consulting a nutritionist for a healthy weight gain plan.
                                    </p>
                                {% elif user.bmi <= 24.9 %}
                                    <p class="text-success mb-0">
                                        <i class="fas fa-check-circle me-2"></i>
                                        Great! You're in the healthy weight range. Keep maintaining your current lifestyle.
                                    </p>
                                {% elif user.bmi <= 29.9 %}
                                    <p class="text-warning mb-0">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        You're overweight. Consider increasing physical activity and monitoring calorie intake.
                                    </p>
                                {% else %}
                                    <p class="text-danger mb-0">
                                        <i class="fas fa-exclamation-circle me-2"></i>
                                        You're in the obese range. Consider consulting a healthcare professional for guidance.
                                    </p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="insight-item mb-3">
                                <h6 class="text-primary">Experience Level</h6>
                                {% if user.experience_level == 1 %}
                                    <p class="text-info mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        As a beginner, focus on learning proper form and building consistency.
                                    </p>
                                {% elif user.experience_level == 2 %}
                                    <p class="text-success mb-0">
                                        <i class="fas fa-thumbs-up me-2"></i>
                                        Great progress! You can now focus on increasing intensity and variety.
                                    </p>
                                {% else %}
                                    <p class="text-primary mb-0">
                                        <i class="fas fa-star me-2"></i>
                                        Excellent! Consider periodization and advanced training techniques.
                                    </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // BMI Calculator
    const heightInput = document.getElementById('height');
    const weightInput = document.getElementById('weight');
    const bmiValue = document.getElementById('bmiValue');
    const bmiCategory = document.getElementById('bmiCategory');
    const bmiDisplay = document.getElementById('bmiDisplay');
    
    function calculateBMI() {
        const height = parseFloat(heightInput.value);
        const weight = parseFloat(weightInput.value);
        
        if (height && weight && height > 0) {
            const bmi = weight / (height * height);
            const roundedBMI = Math.round(bmi * 10) / 10;
            
            bmiValue.textContent = roundedBMI;
            
            let category = '';
            let alertClass = 'alert-info';
            
            if (bmi < 18.5) {
                category = 'Underweight';
                alertClass = 'alert-warning';
            } else if (bmi < 25) {
                category = 'Normal weight';
                alertClass = 'alert-success';
            } else if (bmi < 30) {
                category = 'Overweight';
                alertClass = 'alert-warning';
            } else {
                category = 'Obese';
                alertClass = 'alert-danger';
            }
            
            bmiCategory.textContent = category;
            bmiDisplay.className = `alert ${alertClass}`;
            
            // Update progress bar
            const progressBar = bmiDisplay.querySelector('.progress-bar');
            const percentage = Math.min(100, Math.max(0, ((bmi - 15) / 20) * 100));
            progressBar.style.width = percentage + '%';
            
            // Update progress bar color
            progressBar.className = 'progress-bar ';
            if (bmi < 18.5) {
                progressBar.classList.add('bg-warning');
            } else if (bmi <= 24.9) {
                progressBar.classList.add('bg-success');
            } else if (bmi <= 29.9) {
                progressBar.classList.add('bg-warning');
            } else {
                progressBar.classList.add('bg-danger');
            }
        }
    }
    
    heightInput.addEventListener('input', calculateBMI);
    weightInput.addEventListener('input', calculateBMI);
    
    // Form submission
    const profileForm = document.getElementById('profileForm');
    profileForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        
        fetch('/profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Profile updated successfully!');
                location.reload();
            } else {
                alert(data.message || 'Update failed');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Fallback to regular form submission
            profileForm.submit();
        });
    });
});
</script>

<style>
.profile-avatar {
    width: 100px;
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.profile-stat {
    padding: 15px 0;
    border-bottom: 1px solid #f0f0f0;
}

.profile-stat:last-child {
    border-bottom: none;
}

.stat-label {
    display: block;
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 5px;
}

.stat-value {
    display: block;
    font-weight: 600;
    color: #495057;
    font-size: 1.1rem;
}

.insight-item {
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 10px;
    border-left: 4px solid #007bff;
}

.card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.card-header {
    border-radius: 15px 15px 0 0 !important;
    border-bottom: 1px solid #f0f0f0;
}

.form-control:focus, .form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.btn-primary {
    border-radius: 10px;
    padding: 12px;
}

.alert {
    border-radius: 10px;
}

.progress {
    border-radius: 10px;
}

.bmi-chart {
    text-align: center;
}

h6.text-primary {
    border-bottom: 2px solid #007bff;
    padding-bottom: 5px;
}
</style>
{% endblock %}